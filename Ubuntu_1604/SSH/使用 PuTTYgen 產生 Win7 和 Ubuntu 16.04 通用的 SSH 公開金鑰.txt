使用 PuTTYgen 產生 Win7 和 Ubuntu 16.04 通用的 SSH 公開金鑰


	為了方便管理 Ubuntu 系統，管理人員常會使用 SSH 公開金鑰登入的方法來登入系統。
	
	有時，管理者會從 Ubuntu 系統 SSH 連線到目標伺服器。
	
	有時，管理者會在 Win7 環境中使用 XShell 軟體 SSH 連線到目標伺服器。

	由於在 Ubuntu 下產生的私密金鑰格式和在 XShell 中產生的私密金鑰格式不同，
	
	因此在 Ubuntu 下產生的私密金鑰不能直接供 XShell 使用，
	
	所以，需要 PuTTYgen 來做金鑰的格式轉換，
	
	這樣就可以達到不論是從 Win7 或是從 Ubuntu 執行 SSH 連線到目標伺服器都可以使用同一對金鑰。
	
	本文主要分為三個部分：
	
	第一部分是在 Ubuntu 下建立 RSA 金鑰，並建立 Ubuntu 間的 SSH 連線。
	
	第二部分是將 Ubuntu 的 RSA 私鑰拷貝到 Win7 系統，並儲存成文字檔，再由 PuTTYgen 轉換成 OpenSSH 格式。
	
	第三部分是由 XShell 匯入 OpenSSH 格式的 RSA 私鑰，再使用 XShell 設定與 Ubuntu 之間的連線。
	
	詳細說明如下：
	
	1.在 Ubuntu 下建立 RSA 金鑰，並建立 Ubuntu 間的 SSH 連線，程序如下：
	
		(1).建立金鑰
		
			$ ssh-keygen
			Generating public/private rsa key pair.
			Enter file in which to save the key (/home/user/.ssh/id_rsa): 
			Created directory '/home/user/.ssh'.
			Enter passphrase (empty for no passphrase): 
			Enter same passphrase again: 
			Your identification has been saved in /home/user/.ssh/id_rsa.
			Your public key has been saved in /home/user/.ssh/id_rsa.pub.
			...
		
		(2).在 Ubuntu 之間建立 SSH 連線。
		
			$ ssh-copy-id [username]@[ip address]
			/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/home/user/.ssh/id_rsa.pub"
			
			Number of key(s) added: 1
			
			Now try logging into the machine, with:   "ssh 'user@10.10.1.82'"
			and check to make sure that only the key(s) you wanted were added.
			

	2.使用 PuTTYgen 將金鑰轉換成 OpenSSH 格式
	
		(1).在 Ubuntu 中執行下列指令
		
			$ cd ~/.ssh
			$ cat id_rsa
			-----BEGIN RSA PRIVATE KEY-----
			...
			-----END RSA PRIVATE KEY-----
			
		(2).將 -----BEGIN ... END RSA PRIVATE KEY----- 的內容拷貝起來，在 Win7 下存成文字檔。
		
		(3).下載 PuTTYgen 軟體：
		
			https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html
			
		(4).執行 PuTTYgen 軟體：
		
			使用功能列的 conversions -> Import key 匯入剛剛的文字檔。
			
			再使用功能列的 conversions -> Export OpenSSH key 匯出成 OpenSSH 格式的私鑰。
			
		(5).儲存私鑰：
		
			使用畫面中的 Save private key 按鈕儲存私鑰，會得到一個.ppk的檔案，
			
			這是 PuTTYgen 的專屬格式檔。
			
		接下來，就可以使用 XShell 軟體建立與 Ubuntu 系統的連線了。


	3.建立 Win7 和 Ubuntu 系統的 SSH 連線。
	
	
		(1).使用工具列的 工具(T) -> 使用者金鑰管理(U)... -> 匯入 功能匯入剛剛的 OpenSSH 私鑰。
		
		(2).點選剛剛匯入的私鑰，再點擊 內容 按鈕，會跳出一個 xxxx - 內容 的視窗。
		
		(3).點選 公開金鑰 頁面，拷貝公開金鑰格式(P) 裡面的所有內容。
		
		(4).將第(3)步驟的內容寫入 Ubuntu 系統的 ~/.ssh/authorized_key 檔案。
		
		(5).修改 Ubuntu 系統的 /etc/ssh/sshd_config
		
			$ sudo nano /etc/ssh/sshd_config
			
			找到 #AuthorizedKeysFile	%h/.ssh/authorized_keys
			
			將前面的 # 移除
			
			儲存檔案並重啟 SSH 服務
			
			$ sudo service ssh restart
			
		(6).改變 XShell 的 SSH 連線方式
		
			將 工作階段屬性 -> 使用者驗證 -> 方法 從 password 改為 public key
			
			並選擇 使用者金鑰 後按下 確定 按鈕。
			
		(7).測試連線。
		
			
	到此就完成了 SSH 的連線設定。

		
		
		
	


	